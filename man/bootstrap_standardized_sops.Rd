% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/taooh_bootstrap.R
\name{bootstrap_standardized_sops}
\alias{bootstrap_standardized_sops}
\title{Bootstrap confidence intervals for standardized state occupancy probabilities}
\usage{
bootstrap_standardized_sops(
  model,
  data,
  n_boot,
  workers = NULL,
  parallel = FALSE,
  ylevels = 1:6,
  absorb = 6,
  times = NULL,
  varnames = list(tvarname = "time", pvarname = "yprev", id = "id", tx = "tx")
)
}
\arguments{
\item{model}{A fitted model object from \code{rms::orm} or \code{VGAM::vglm}.
For \code{orm}, should be fitted with \code{x = TRUE, y = TRUE} to enable
model updating with bootstrap samples.}

\item{data}{A data frame containing the patient trajectory data}

\item{n_boot}{Number of bootstrap samples}

\item{workers}{Number of workers used for parallelization. Default is
NULL}

\item{parallel}{Whether parallelization should be used (default FALSE).
Set to TRUE only if this function is being called in isolation. If you're
running multiple simulations in parallel at a higher level, keep this FALSE
to avoid nested parallelization and resource contention.}

\item{ylevels}{States in the data (e.g., 1:6)}

\item{absorb}{Absorbing state (e.g., 6 for death)}

\item{times}{Time points in the data. Default is \code{1:max(data[["time"]])}}

\item{varnames}{List of variable names in the data with components:
\itemize{
\item tvarname: time variable name (default "time")
\item pvarname: previous state variable name (default "yprev")
\item id: patient identifier (default "id")
\item tx: treatment indicator (default "tx")
}}
}
\value{
A tibble with columns:
\itemize{
\item boot_id: Bootstrap iteration number
\item time: Time point
\item tx: Treatment indicator (0 = control, 1 = treatment)
\item state_1, state_2, ..., state_K: Probability of being in each state
at the given time point under the given treatment
}
Each bootstrap iteration contributes 2 * length(times) rows (one set for
treatment, one set for control).
}
\description{
Performs group bootstrap resampling to compute confidence intervals for
standardized state occupancy probabilities (SOPs) across all states and time
points. Uses g-computation to estimate marginal (population-averaged) SOPs
under treatment and control.
}
\details{
For each bootstrap iteration:
\enumerate{
\item Extracts the bootstrap sample and creates unique IDs
\item Uses \code{\link{relevel_factors_consecutive}} to handle missing states
by releveling to consecutive integers and updating ylevels/absorb
\item Refits the model using the bootstrap sample
\item Computes standardized SOPs using \code{\link{standardize_sops}}
\item Expands results back to original state space, padding with zeros for missing states
}

\strong{Handling missing states:}
When a state (e.g., state 3) is missing from a bootstrap sample:
\itemize{
\item The model is fit on releveled data (states 1,2,4,5,6 become 1,2,3,4,5)
\item SOPs are predicted for the releveled states
\item Results are mapped back to original state numbering (1,2,3,4,5,6)
\item Missing state 3 is assigned probability 0 at all time points
}

This ensures that all bootstrap iterations return SOPs for all original states,
which is required for computing valid confidence intervals.

\strong{Output format:} The function returns a single long-format tibble
containing both treatment and control SOPs across all bootstrap iterations.
Each row represents one time point for one treatment group in one bootstrap
iteration. This format makes it easy to:
\itemize{
\item Filter by treatment group (tx == 0 or tx == 1)
\item Compute confidence bands using group_by(time, tx) and quantiles
\item Plot results with ggplot2
\item Calculate treatment effects by comparing tx == 1 vs tx == 0
}

Parallelization is handled via future.callr::callr strategy, which provides
isolated R processes for each worker.
}
\examples{
\dontrun{
# Fit initial model
d <- rms::datadist(my_data)
options(datadist = "d")
m <- orm(y ~ tx + yprev + time, data = my_data, x = TRUE, y = TRUE)

# Bootstrap standardized SOPs
bs_sops <- bootstrap_standardized_sops(
  model = m,
  data = my_data,
  n_boot = 1000,
  ylevels = 1:6,
  absorb = 6
)

# Compute 95\% confidence bands for treatment SOPs
library(dplyr)
library(tidyr)

# Filter to treatment group and reshape to long format
sops_tx_long <- bs_sops |>
  filter(tx == 1) |>
  pivot_longer(
    cols = starts_with("state_"),
    names_to = "state",
    values_to = "probability",
    names_prefix = "state_"
  )

# Compute confidence intervals
ci_bands <- sops_tx_long |>
  group_by(time, state) |>
  summarise(
    lower = quantile(probability, 0.025),
    median = median(probability),
    upper = quantile(probability, 0.975),
    .groups = "drop"
  )

# Plot with confidence bands
library(ggplot2)
ggplot(ci_bands, aes(x = time, y = median, color = state)) +
  geom_line() +
  geom_ribbon(aes(ymin = lower, ymax = upper, fill = state), alpha = 0.2) +
  facet_wrap(~state) +
  labs(title = "Standardized SOPs under Treatment with 95\% CI")
}
}
\keyword{bootstrap}
\keyword{g-computation}
\keyword{occupancy}
\keyword{standardization}
\keyword{state}
