% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/sops_new.R
\name{inferences}
\alias{inferences}
\title{Inference for State Occupation Probabilities}
\usage{
inferences(
  object,
  method = "simulation",
  n_sim = 1000,
  n_boot = NULL,
  vcov = NULL,
  parallel = FALSE,
  workers = NULL,
  conf_level = 0.95,
  conf_type = "perc",
  return_draws = FALSE,
  update_datadist = TRUE,
  use_coefstart = FALSE,
  ...
)
}
\arguments{
\item{object}{A \code{markov_avg_sops} object from \code{avg_sops()} or a
\code{markov_sops} object from \code{sops()}.}

\item{method}{Character. Inference method:
\itemize{
\item \code{"simulation"} (default): Draws from MVN(beta_hat, Sigma). Fast,
does not refit models. Works for both individual and averaged SOPs.
\item \code{"bootstrap"}: Resamples patients with replacement, refits model.
More robust but slower. Only works for \code{markov_avg_sops} objects.
}}

\item{n_sim}{Number of simulation draws (for simulation) or bootstrap
iterations (for bootstrap). Default is 1000.}

\item{n_boot}{Deprecated alias for \code{n_sim} when using bootstrap method.
For backward compatibility.}

\item{vcov}{Optional custom variance-covariance matrix. If provided,
overrides the vcov extracted from the model. This is useful for sensitivity
analyses with inflated variance.}

\item{parallel}{Logical. Use parallel processing? Default is FALSE.}

\item{workers}{Number of parallel workers. If NULL, uses detectCores() - 1.}

\item{conf_level}{Confidence level for intervals (default 0.95).}

\item{conf_type}{Type of confidence interval (simulation method only):
\itemize{
\item \code{"perc"} (default): Percentile-based intervals from the simulation
distribution.
\item \code{"wald"}: Uses simulation standard errors with normal quantiles.
}}

\item{return_draws}{Logical. If TRUE, stores all individual simulation/bootstrap
draws as an attribute. Extract with \code{get_draws()}. Default is FALSE.}

\item{update_datadist}{Logical. Whether to update datadist for rms models
during bootstrap. Default is TRUE.}

\item{use_coefstart}{Logical. Use original coefficients as starting values
for bootstrap refitting. Default is FALSE.}

\item{...}{Additional arguments (currently unused).}
}
\value{
The input object with added columns:
\item{conf.low}{Lower confidence bound}
\item{conf.high}{Upper confidence bound}
\item{std.error}{Standard error from simulation/bootstrap}

If \code{return_draws = TRUE}, the object also has a \code{"simulation_draws"} or
\code{"bootstrap_draws"} attribute containing all individual draws. Extract
with \code{get_draws()}.
}
\description{
Adds confidence intervals to SOP objects using simulation-based (MVN) or
bootstrap methods. The default method is simulation, which draws coefficient
vectors from a multivariate normal distribution centered at the point
estimates. This is typically much faster than bootstrap as it does not
require refitting the model.
}
\details{
\subsection{Simulation Method (Default)}{

The simulation method (Krinsky & Robb, 1986) proceeds as follows:
\enumerate{
\item Extract coefficient vector beta_hat and (robust) variance-covariance Sigma
\item Draw n_sim coefficient vectors from MVN(beta_hat, Sigma)
\item For each draw, replace model coefficients and compute SOPs
\item Compute confidence intervals from the empirical distribution
}

\strong{Advantages:}
\itemize{
\item Much faster than bootstrap (no model refitting)
\item Works for both individual-level (\code{sops()}) and averaged (\code{avg_sops()}) SOPs
\item Supports robust (cluster) variance estimation via \code{cluster} argument
}

\strong{When to use:}
\itemize{
\item Default choice for most applications
\item When speed is important
\item When the normal approximation for coefficients is reasonable
}
}

\subsection{Bootstrap Method}{

The bootstrap method resamples patients and refits the model:
\enumerate{
\item Sample patient IDs with replacement
\item Refit model on bootstrap sample (handles missing states)
\item Compute SOPs using G-computation
\item Compute percentile-based confidence intervals
}

\strong{Advantages:}
\itemize{
\item Makes no distributional assumptions about coefficients
\item Properly handles rare states that may be missing from samples
}

\strong{When to use:}
\itemize{
\item When the normal approximation may be poor (small samples, near boundaries)
\item When you need to verify simulation-based results
}

\strong{Important:} Bootstrap requires the full longitudinal dataset (all time
points) in the original \code{newdata} passed to \code{avg_sops()}, not just baseline
data. This is because the model must be refit on each bootstrap sample.
}

\subsection{Cluster-Robust Variance}{

For longitudinal data with repeated measurements per patient, you should
use cluster-robust standard errors. To do this, wrap your model with
\code{robcov_vglm()} (for vglm) or \code{rms::robcov()} (for orm) \strong{before} passing
it to \code{sops()} or \code{avg_sops()}:

\if{html}{\out{<div class="sourceCode r">}}\preformatted{# Fit model
fit <- vglm(y ~ time + tx + yprev, family = cumulative(...), data = data)

# Wrap with cluster-robust vcov
fit_robust <- robcov_vglm(fit, cluster = data$id)

# Use in workflow - vcov is automatically extracted
avg_sops(model = fit_robust, ...) |> inferences()
}\if{html}{\out{</div>}}

This design ensures consistency: the same vcov is used for both point
estimates and inference, regardless of how \code{inferences()} is called.
}
}
\examples{
\dontrun{
# Step 1: Fit model and wrap with cluster-robust vcov
fit <- vglm(y ~ time + tx + yprev, family = cumulative(...), data = data)
fit_robust <- robcov_vglm(fit, cluster = data$id)

# Step 2a: Simulation inference (use baseline data only)
baseline_data <- data |> filter(time == 1)
result_sim <- avg_sops(
  model = fit_robust,
  newdata = baseline_data,  # Baseline only for simulation
  variables = list(tx = c(0, 1)),
  times = 1:60,
  ylevels = 1:6,
  absorb = 6,
  id_var = "id"
) |>
  inferences(method = "simulation", n_sim = 1000)

# Step 2b: Bootstrap inference (must use full data)
result_boot <- avg_sops(
  model = fit_robust,
  newdata = data,  # Full longitudinal data for bootstrap
  variables = list(tx = c(0, 1)),
  times = 1:60,
  ylevels = 1:6,
  absorb = 6,
  id_var = "id"
) |>
  inferences(method = "bootstrap", n_sim = 500, parallel = TRUE)

# Individual-level SOPs with simulation inference
ind_result <- sops(model = fit_robust, newdata = test_data, times = 1:30) |>
  inferences(n_sim = 500)

# Extract draws for custom analyses
result_draws <- avg_sops(model = fit_robust, ...) |>
  inferences(return_draws = TRUE)
draws <- get_draws(result_draws)

# Compute treatment effect on time in state
library(dplyr)
library(tidyr)
treatment_effect <- draws |>
  filter(state == 1) |>
  group_by(draw_id, tx) |>
  summarise(total_time = sum(estimate), .groups = "drop") |>
  pivot_wider(names_from = tx, values_from = total_time) |>
  mutate(effect = `1` - `0`)
quantile(treatment_effect$effect, c(0.025, 0.5, 0.975))
}

}
\seealso{
\code{\link[=avg_sops]{avg_sops()}}, \code{\link[=sops]{sops()}}, \code{\link[=get_draws]{get_draws()}}, \code{\link[=robcov_vglm]{robcov_vglm()}},
\code{\link[=set_coef]{set_coef()}}

\code{\link[=get_draws]{get_draws()}} to extract individual draws from any inference method
}
