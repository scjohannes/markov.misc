% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/sops.R
\name{soprob_markov}
\alias{soprob_markov}
\title{Calculate State Occupation Probabilities for First-Order Markov Models}
\usage{
soprob_markov(
  object,
  data,
  times,
  ylevels,
  absorb = NULL,
  tvarname = "time",
  pvarname = "yprev",
  gap = NULL,
  t_covs = NULL
)
}
\arguments{
\item{object}{A fitted model object. Supported classes include:
\code{"lrm"}, \code{"orm"} (from package \code{rms}),
\code{"blrm"} (from package \code{rmsb}), and
\code{"vglm"}, \code{"vgam"} (from package \code{VGAM}).}

\item{data}{A data frame containing the baseline covariates for the prediction.
Rows represent unique patients. Columns must contain baseline covariates and
initial values for time-varying variables.}

\item{times}{A numeric vector of time points to iterate over.
The function calculates probabilities for each time point in this sequence.}

\item{ylevels}{A character vector defining the names of the outcome levels (states).
These must match the levels used in the fitted \code{object}.}

\item{absorb}{(Optional) A character vector of absorbing states (states from which
transitions out are impossible). Defaults to \code{NULL}.}

\item{tvarname}{A character string specifying the name of the time variable in the
model formula. Defaults to \code{"time"}.}

\item{pvarname}{A character string specifying the name of the previous state variable
used in the model formula. Defaults to \code{"yprev"}.}

\item{gap}{(Optional) A character string specifying the name of the variable representing
the time gap (delta time) between observations, if used in the model. Defaults to \code{NULL}.}

\item{t_covs}{(Optional) A data frame used for non-linear time handling (e.g., splines
or basis functions).
\itemize{
\item \strong{Structure:} The number of rows in \code{t_covs} must exactly match the length of \code{times}.
\item \strong{Columns:} Column names must match the specific basis variables used in the model formula (e.g., \code{t1}, \code{t2}).
\item \strong{Usage:} At step \code{i}, the values from the \code{i}-th row of \code{t_covs} are injected into the prediction data.
}
This allows for \code{vglm} models where basis functions are supplied as separate columns rather than calculated on the fly.}
}
\value{
An array of state probabilities.
\itemize{
\item \strong{Frequentist fit:} An array of dimension \code{[n_patients x n_times x n_states]}.
\item \strong{Bayesian fit:} An array of dimension \code{[n_draws x n_patients x n_times x n_states]}.
}
}
\description{
Estimates state occupation probabilities over time by iterating a transition
matrix derived from a fitted model object (e.g., \code{vglm}, \code{rms}, or \code{rmsb}).
This function supports linear time iteration as well as complex, non-linear
time specifications (e.g., splines) via a covariate lookup table.
}
\details{
\strong{1. Data Expansion:}
We construct a "long" expansion dataset at every time point. For \eqn{N} patients
and \eqn{K} non-absorbing states, the expansion dataset contains \eqn{N \times K} rows.
\itemize{
\item Rows \eqn{1 \dots N}: All patients assuming \eqn{y_{prev} = \text{State } 1}
\item Rows \eqn{(N+1) \dots 2N}: All patients assuming \eqn{y_{prev} = \text{State } 2}
\item ... and so on.
}
This allows a single \code{predict()} call to generate transition probabilities for the entire
cohort for all possible previous states in one step.

\strong{2. Element-wise weighted sum}
We use an element-wise weighted sum approach based on the
Law of Total Probability:
\deqn{P(S_t = k) = \sum_{j} P(S_{t-1} = j) \times P(S_t = k | S_{t-1} = j)}

where:
\itemize{
\item \eqn{S_t}: State occupied at time \eqn{t}.
\item \eqn{S_{t-1}}: State occupied at time \eqn{t-1}.
\item \eqn{k}: The target state at time \eqn{t}.
\item \eqn{j}: The origin state at time \eqn{t-1}.
}

Let \eqn{\mathbf{v}_{prev, j}} be a vector of length \eqn{N} containing the probability that each
patient was in state \eqn{j} at time \eqn{t-1}.
Let \eqn{\mathbf{M}_{trans, j \to k}} be a vector of length \eqn{N} containing the transition
probability from \eqn{j} to \eqn{k} for each patient (derived from the batched prediction).

The probability of being in state \eqn{k} at time \eqn{t} is updated as:
\deqn{\mathbf{v}_{curr, k} = \sum_{j} (\mathbf{v}_{prev, j} \odot \mathbf{M}_{trans, j \to k})}
where \eqn{\odot} denotes element-wise multiplication.

\strong{3. Absorbing States:}
If an absorbing state \eqn{a} is present, the update logic handles the accumulation of probability mass:
\deqn{P(S_t = a) = P(S_{t-1} = a) + \sum_{j \neq a} P(S_{t-1} = j) \times P(S_t = a | S_{t-1} = j)}
}
