% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/sops_new.R
\name{avg_sops}
\alias{avg_sops}
\title{Calculate Averaged State Occupation Probabilities (Marginal Effects)}
\usage{
avg_sops(
  model,
  newdata = NULL,
  variables = NULL,
  by = NULL,
  times = NULL,
  id_var = "id",
  ...
)
}
\arguments{
\item{model}{A fitted model object (e.g., \code{vglm}, \code{orm}).}

\item{newdata}{Data frame for prediction. For \strong{simulation inference}, pass
baseline data only (one row per patient). For \strong{bootstrap inference}, you
must pass the full longitudinal dataset (all time points) since the model
needs to be refit on bootstrap samples. If NULL, extracts from model.}

\item{variables}{A named list specifying the variable(s) to standardize over.
E.g., \code{list(tx = c(0, 1))} creates counterfactual datasets for treatment
and control. \strong{Required} - G-computation needs a treatment variable.}

\item{by}{Optional character vector of additional variables to group by.}

\item{times}{Numeric vector of time points. If NULL, inferred from data.}

\item{id_var}{Name of the patient ID variable (default "id"). Required for
bootstrap inference.}

\item{...}{Additional arguments passed to \code{sops()} (e.g., \code{ylevels}, \code{absorb},
\code{tvarname}, \code{pvarname}, \code{t_covs}).}
}
\value{
A data frame of class \code{markov_avg_sops} with columns:
\item{time}{Time point}
\item{state}{State level}
\item{(variables)}{Value of standardization variable (e.g., tx)}
\item{estimate}{Average probability across individuals}
}
\description{
Computes standardized (marginal) state occupation probabilities using
G-computation. Creates counterfactual cohorts by setting all individuals
to each level of the treatment variable and averaging over the covariate
distribution.
}
\details{
This function implements G-computation (standardization) for Markov SOPs:
\enumerate{
\item \strong{Counterfactual Creation}: For each value in \code{variables}, creates a
copy of \code{newdata} with that variable set to the specified value.
\item \strong{Individual Prediction}: Calls \code{sops()} to compute individual-level
SOPs for each patient under each counterfactual scenario.
\item \strong{Marginalization}: Averages individual SOPs across patients within
each time-state-treatment combination, yielding population-average
(marginal) probabilities.
}

The result represents the expected SOP if the entire population received
treatment vs. control, averaged over the observed covariate distribution.
}
\examples{
\dontrun{
# For simulation inference: use baseline data (one row per patient)
baseline_data <- data |> filter(time == 1)
result <- avg_sops(
  model = fit,
  newdata = baseline_data,
  variables = list(tx = c(0, 1)),
  times = 1:60,
  ylevels = 1:6,
  absorb = 6
) |> inferences(method = "simulation", n_sim = 1000)

# For bootstrap inference: must use full data (all time points)
result_boot <- avg_sops(
  model = fit,
  newdata = data,  # Full longitudinal data
  variables = list(tx = c(0, 1)),
  times = 1:60,
  ylevels = 1:6,
  absorb = 6
) |> inferences(method = "bootstrap", n_sim = 500)
}

}
\seealso{
\code{\link[=sops]{sops()}} for individual-level SOPs, \code{\link[=inferences]{inferences()}} for bootstrap
uncertainty, \code{\link[=standardize_sops]{standardize_sops()}} for the underlying implementation.
}
